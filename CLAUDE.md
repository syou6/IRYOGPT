# WebGPT 医療・歯科業界向け改良計画

## ビジョン
**予約対応の人件費削減**を主軸に、病院・歯科医院向けのAI予約チャットボットとして展開する。

---

## ターゲット市場

### 主要ターゲット
- **歯科医院**（個人開業医〜医療法人）
- **クリニック**（内科、皮膚科、美容外科など）
- **中小規模病院**

### なぜこの市場か？
1. 経営が安定的で資本がある
2. 電話対応による業務中断が深刻な課題
3. 受付スタッフが助手を兼任しているケースが多い
4. 24時間対応ニーズがある（夜間・休診日の予約取りこぼし）

---

## コア機能：予約システム統合

### 動作イメージ

```
[患者] → [チャットボット] → [予約DB] → [医院側管理画面]
                ↑                ↓
                └── 空き状況参照 ──┘
```

### フロー

#### 1. 空き状況確認（Read）
```
患者：「来週の火曜の10時は空いてる？」
Bot：（DBを参照）
Bot：「はい、空いています」or「埋まっていますが11時なら空いています」
```

#### 2. 予約確定（Write）
```
患者：「じゃあ10時にお願い」
Bot：（DBに書き込み）
Bot：「予約を完了しました。確認メールをお送りしました」
```

---

## 技術実装方針

### Phase 1: Googleカレンダー連携（推奨・最優先）

**理由：**
- 導入ハードルが最も低い
- 病院側はスマホで予約確認可能
- スタッフの電話予約も同じカレンダーに入力→ダブルブッキング防止
- Google Calendar API で開発工数が少ない

**売り文句：**
> 「今の紙の台帳をGoogleカレンダーに変えるだけで、AIが勝手に空き枠に予約を入れてくれます」

**必要な開発：**
- [ ] Google Calendar API 連携
- [ ] 空き枠検索ロジック
- [ ] 予約書き込み機能
- [ ] 確認メール自動送信

### Phase 2: 独自予約DB（オプション）

**テーブル設計案：**
```sql
-- 診療枠マスタ
appointment_slots:
  id, site_id, date, start_time, end_time
  is_available (boolean)
  max_patients (integer) -- 同時間帯の上限

-- 予約
appointments:
  id, site_id, slot_id
  patient_name, patient_phone, patient_email
  symptom (text) -- 症状・相談内容
  status (confirmed/cancelled/completed)
  created_at, confirmed_at

-- 患者マスタ（リピーター対応）
patients:
  id, site_id, name, phone, email
  last_visit, visit_count
```

### Phase 3: 既存システム連携（将来）

- EPARK、デジスマ診療などのAPI連携
- 電子カルテ連携（難易度高・要相談）

---

## 訴求ポイント（営業用）

### 歯科医院向け
> 「受付スタッフを1人雇うコストの1/10以下で、24時間365日予約対応」
>
> 「『今、手が離せないのに』をゼロへ。電話対応をAIに任せて、スタッフは患者様のケアに集中できます」
>
> 「休診日や昼休みの予約取りこぼし（機会損失）を防ぎます」

### クリニック向け
> 「『よくある質問』による電話を8割削減。本当に緊急な電話だけをスタッフへ」
>
> 「24時間自動対応で、夜間の予約ニーズを確実にキャッチ」

---

## 医療業界特有の「3つの壁」と対策

### 1. ハルシネーション（誤情報）への不安
**対策：**
- 「医療アドバイスはしません。あくまで『案内係』に徹します」
- 学習データ以外は回答しない設定を強調
- プロンプトに明確な制約を入れる

### 2. 既存システムとの連携
**対策（松竹梅）：**
- **松**: API連携で予約完結（開発コスト高）
- **竹**: ヒアリング後、既存予約サイトへ誘導（推奨）
- **梅**: 希望日時をメール通知（手動入力必要）

### 3. IT苦手意識
**対策：**
- 「埋め込みコード1行貼るだけ」
- **初期設定代行オプション**を提供（成約率UP）

---

## 営業戦略

### Step 1: モニター獲得（1〜3件）
- 知り合いの歯医者・クリニックに無料モニター依頼
- 「電話が1日〇件減った」「夜間予約が増えた」の数値データを取得

### Step 2: デモサイト作成
- 架空の「〇〇歯科クリニック」サイト
- 実際に予約フローを体験できるデモ
- 動画デモも用意

### Step 3: 営業アプローチ
- **FAX DM**（医療業界はまだFAXが有効）
- お問い合わせフォーム営業
- 「受付採用にお困りの院長先生へ」という切り口

---

## 料金プラン案（医療向け）

| プラン | 月額 | 予約数 | 機能 |
|--------|------|--------|------|
| ライト | ¥9,800 | 100件/月 | 基本予約 |
| スタンダード | ¥29,800 | 500件/月 | +リマインド通知 |
| プレミアム | ¥49,800 | 無制限 | +複数診療科対応、API連携 |

※ 初期設定代行: ¥30,000〜50,000

---

## 開発優先度

1. **Google Calendar API 連携** ← 最優先
2. 予約確認メール自動送信
3. 医療向けプロンプトテンプレート
4. 予約リマインド通知（LINE/SMS）
5. 独自予約DBオプション
6. 管理画面（予約一覧・分析）

---

## 競合との差別化

- **既存の予約システム**: UI操作が必要、患者が入力
- **WebGPT**: 会話で完結、自然言語で予約、24時間対応

**キャッチ：**
> 「予約フォームに入力させるのではなく、患者さんと会話して予約を取る」

---

## ハイブリッドモード機能仕様書

> 作成日: 2025/01/28

### 概要

予約機能（スプレッドシート連携）とRAG機能（WEBサイト情報検索）を組み合わせたハイブリッドモード。
患者が予約を取りながら、WEBサイトに掲載された診療内容・アクセス情報なども回答できる。

---

### チャットモード一覧

| モード | 説明 | 用途 |
|--------|------|------|
| **RAGのみ** | WEBサイト情報で回答（従来機能） | FAQ対応、情報案内 |
| **予約のみ** | スプレッドシートで予約対応 | 予約特化型 |
| **ハイブリッド** | 両方を使用（新機能）★推奨 | 予約 + 情報案内 |

---

### 対象範囲

- ダッシュボードチャット（管理者・テスト用）
- 埋め込みウィジェット（エンドユーザー向け）

両方に適用する。

---

### 処理フロー（ハイブリッドモード）

```
ユーザー質問
    │
    ▼
┌─────────────────────────────────────┐
│ ① RAG検索（常に実行）               │
│    - site_idでベクトル検索          │
│    - 類似度 >= 0.6 のチャンク取得    │
│    - 上位1-2件（約500トークン）      │
└─────────────────────────────────────┘
    │
    ▼ 成功 or 失敗
    │
┌─────────────────────────────────────┐
│ ② コンテキスト構築                  │
│    - RAG結果あり → WEBサイト情報     │
│    - RAG結果なし → 「見つかりません」 │
└─────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────┐
│ ③ LLM + Function Calling           │
│    - システムプロンプト（RAG情報含む）│
│    - 予約ツール（スプレッドシート）   │
│    - ストリーミングレスポンス        │
└─────────────────────────────────────┘
    │
    ▼
ユーザーへ回答
```

---

### RAG検索仕様

| 項目 | 設定値 |
|------|--------|
| 検索タイミング | 常に実行（全ての質問） |
| 取得チャンク数 | 1-2件 |
| トークン数目安 | 約500トークン |
| 類似度閾値 | 0.6 |
| 結果なしの場合 | 「WEBサイト情報は見つかりませんでした」とコンテキストに明記 |

---

### 予約ツール（Function Calling）

| ツール名 | 説明 | データソース |
|----------|------|--------------|
| `get_available_slots` | 指定日の空き枠を取得 | スプレッドシート |
| `create_appointment` | 予約を作成 | スプレッドシート |
| `get_clinic_info` | 医院情報を取得 | スプレッドシート |

---

### システムプロンプト構成

```
あなたは医療機関の予約受付AIアシスタントです。

【医院のWEBサイト情報】
{RAG検索結果 or "WEBサイト情報は見つかりませんでした"}

【本日の日付】
{今日の日付}

【重要なルール】
1. 医療アドバイスは絶対にしない
2. 予約に必要な情報を順番に確認する
3. WEBサイト情報も参考にして回答する
...
```

---

### エラーハンドリング

| 状況 | 動作 |
|------|------|
| RAG検索失敗 | 予約機能のみで続行 |
| スプレッドシート接続失敗 | RAG情報のみで回答 |
| 両方失敗 | 「現在サービスを利用できません」エラー表示 |

---

### パフォーマンス

| 項目 | 設定 |
|------|------|
| 処理方式 | 直列処理（RAG → LLM） |
| 予想レスポンス時間 | 約4-5秒 |
| ストリーミング | 現行通り維持（文字が順次表示） |

---

### 管理画面設定UI

**設定場所**: 埋め込み設定画面（`/dashboard/sites/[siteId]/embed`）

```
チャットモード: [ドロップダウン]
├── RAGのみ（WEBサイト情報で回答）
├── 予約のみ（スプレッドシート連携）
└── ハイブリッド（両方使用）★推奨

スプレッドシートID: [入力欄]
※「予約のみ」「ハイブリッド」選択時のみ表示
```

---

### DBスキーマ変更

`sites` テーブルに以下のカラムを追加:

```sql
ALTER TABLE sites ADD COLUMN chat_mode TEXT DEFAULT 'rag_only';
-- 値: 'rag_only' | 'appointment_only' | 'hybrid'
```

---

### 実装対象ファイル

| ファイル | 変更内容 |
|----------|----------|
| `pages/api/chat.ts` | ハイブリッドモード処理追加 |
| `pages/api/embed/chat.ts` | ハイブリッドモード処理追加 |
| `utils/makechain-hybrid.ts` | 新規作成：ハイブリッド用チェーン |
| `pages/dashboard/sites/[siteId]/embed.tsx` | モード選択UI追加 |
| `supabase/migrations/xxx_add_chat_mode.sql` | chat_modeカラム追加 |

---

### 実装ステップ

1. [ ] DBマイグレーション作成（chat_modeカラム追加）
2. [ ] `makechain-hybrid.ts` 作成（RAG + 予約ツール統合）
3. [ ] `/api/chat.ts` にハイブリッドモード分岐追加
4. [ ] `/api/embed/chat.ts` にハイブリッドモード分岐追加
5. [ ] 埋め込み設定画面にモード選択UI追加
6. [ ] テスト・動作確認
