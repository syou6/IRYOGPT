# マークダウンファイルを学習させる方法

特定のサイトにマークダウンファイルを学習させる方法を説明します。

## 概要

`docs/blogs-20251115T024613/` フォルダ内のマークダウンファイルを特定のサイトに学習させることができます。

## 前提条件

1. サイトが既に作成されていること（`sites` テーブルにレコードが存在すること）
2. 環境変数が正しく設定されていること（`.env.local` または `.env`）
3. 必要なパッケージがインストールされていること

## 使用方法

### 1. サイトIDを確認

まず、学習させたいサイトのIDを確認します。ダッシュボードでサイトを確認するか、データベースから直接確認してください。

```sql
SELECT id, name, base_url FROM sites;
```

### 2. スクリプトを実行

以下のコマンドでマークダウンファイルを学習させます：

```bash
npm run train:markdown <site_id> <markdown_folder_path>
```

**例：**

```bash
# docs/blogs-20251115T024613 フォルダ内のすべてのマークダウンファイルを学習
npm run train:markdown abc123 docs/blogs-20251115T024613
```

または、直接 `tsx` コマンドを使用：

```bash
tsx -r dotenv/config scripts/train-markdown-files.ts abc123 docs/blogs-20251115T024613
```

### 3. 実行結果の確認

スクリプトが正常に実行されると、以下の情報が表示されます：

- 読み込まれたマークダウンファイルの数
- 作成されたチャンクの数
- 使用したembeddingトークン数
- 推定コスト

## 処理の流れ

1. **ファイル読み込み**: 指定されたフォルダ内のすべての `.md` ファイルを読み込みます
2. **フロントマター解析**: 各ファイルのフロントマター（YAML）を解析してメタデータを抽出します
3. **チャンク分割**: ドキュメントを1000文字のチャンクに分割します（オーバーラップ200文字）
4. **埋め込み生成**: OpenAIの `text-embedding-3-small` モデルを使用してベクトルを生成します
5. **データベース保存**: Supabaseの `documents` テーブルに保存し、`site_id` を設定します
6. **サイトステータス更新**: サイトのステータスを `ready` に更新します

## 注意事項

- **既存データ**: 既存のドキュメントは削除されません。追加で学習されます。
- **コスト**: 大量のファイルを学習する場合、OpenAIのAPIコストが発生します。
- **ファイル形式**: `.md` 拡張子のファイルのみが処理されます。
- **フロントマター**: フロントマターがなくても処理されますが、メタデータは最小限になります。

## トラブルシューティング

### エラー: Site not found

サイトIDが正しいか確認してください：

```bash
# データベースで確認
SELECT id, name FROM sites WHERE id = 'your-site-id';
```

### エラー: Folder not found

フォルダパスが正しいか確認してください。相対パスはプロジェクトルートからのパスです。

### エラー: No documents found

フォルダ内に `.md` ファイルが存在するか確認してください。

## 関連ファイル

- `utils/markdown_loader.ts` - マークダウンファイル読み込みローダー
- `scripts/train-markdown-files.ts` - 学習スクリプト
- `pages/api/train/url.ts` - URLベースの学習API（参考）

