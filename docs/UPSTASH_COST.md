# 💰 Upstash Redis コスト管理ガイド

## 📊 料金体系

### 無料プラン（Free Tier）

- **10,000コマンド/日** まで無料
- 1日を超えると自動的に有料プランに移行
- **自動課金はされません**（手動で有料プランにアップグレードする必要があります）

### 有料プラン（Pay As You Go）

- **$0.20 / 100,000コマンド**
- 無料プランを超えた分のみ課金
- 最小課金単位: $0.01

## 🔢 コマンド数の計算

### 学習ジョブ1回あたりのコマンド数

BullMQが使用するRedisコマンド（概算）：

| 操作 | コマンド数 | 説明 |
|------|-----------|------|
| ジョブ追加 | 5-10 | `LPUSH`, `HSET`, `ZADD`など |
| ジョブ取得 | 3-5 | `BRPOP`, `HGET`, `ZREM`など |
| 進捗更新 | 2-3 | `HSET`（進捗情報） |
| 完了処理 | 5-8 | `LREM`, `ZADD`, `HSET`など |
| **合計** | **約15-26コマンド/ジョブ** | |

### 実際の使用量例

**1日あたりの学習ジョブ数とコマンド数**：

| ジョブ数/日 | コマンド数（概算） | 無料プラン内？ | 超過分のコスト |
|-----------|-----------------|--------------|--------------|
| 100回 | 約2,000コマンド | ✅ 無料 | - |
| 500回 | 約10,000コマンド | ✅ 無料（上限） | - |
| 600回 | 約12,000コマンド | ❌ 超過 | $0.004/日（約$0.12/月） |
| 1,000回 | 約20,000コマンド | ❌ 超過 | $0.02/日（約$0.60/月） |
| 5,000回 | 約100,000コマンド | ❌ 超過 | $0.18/日（約$5.40/月） |

## 🛡️ 自動課金について

### ⚠️ 重要なポイント

**Upstashは自動課金しません**：

1. 無料プランで10,000コマンド/日を超えても、**自動的に有料プランに移行しない**
2. 10,000コマンド/日を超えると、**エラーが発生する可能性がある**
3. 有料プランに移行するには、**手動でアップグレードする必要がある**

### 無料プランでの動作

- 10,000コマンド/日以内: ✅ 正常動作
- 10,000コマンド/日超過: ⚠️ エラーが発生する可能性（レート制限）

## 📈 使用量の確認方法

### 1. Upstashダッシュボードで確認

1. [Upstash Console](https://console.upstash.com/) にログイン
2. Redisデータベースを選択
3. 「Metrics」タブで使用量を確認
   - 今日のコマンド数
   - 今月のコマンド数
   - コスト見積もり

### 2. コマンドで確認

```bash
npm run check:queue
```

これでキュー統計を確認できます。

## 💡 コスト削減のヒント

### 1. ジョブの自動削除設定

既に設定済み（`lib/queue.ts`）：

```typescript
removeOnComplete: {
  age: 3600, // 1時間後に削除
  count: 1000, // 最大1000件保持
},
removeOnFail: {
  age: 86400, // 24時間後に削除
}
```

これにより、古いジョブが自動削除され、メモリとコマンド数を節約します。

### 2. 進捗更新の頻度を調整

現在は各ページ処理ごとに進捗を更新していますが、必要に応じて間引き可能です。

### 3. ローカル開発環境ではDocker Redisを使用

```bash
docker run -d -p 6379:6379 redis:7-alpine
```

開発環境では完全無料のローカルRedisを使用できます。

## 🚨 アラート設定（推奨）

Upstashダッシュボードで以下を設定：

1. **コマンド数アラート**: 8,000コマンド/日で通知
2. **コストアラート**: 月額$1で通知

## 📝 まとめ

| 項目 | 詳細 |
|------|------|
| **無料プラン** | 10,000コマンド/日まで無料 |
| **自動課金** | ❌ されない（手動アップグレード必要） |
| **学習ジョブ1回** | 約15-26コマンド |
| **無料プランで可能** | 約400-600ジョブ/日 |
| **超過時のコスト** | $0.20/100Kコマンド（非常に安い） |

## ✅ 結論

- **無料プランで十分**: 1日400-600回の学習ジョブまで無料
- **自動課金なし**: 手動でアップグレードしない限り課金されない
- **コストが低い**: 超過しても$0.20/100Kコマンドと非常に安い
- **監視可能**: Upstashダッシュボードで使用量を確認できる

安心して使用できます！

