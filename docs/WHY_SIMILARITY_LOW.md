# Similarityスコアが低い理由

## Similarityスコアとは？

Similarityスコアは、**質問の埋め込みベクトルとドキュメントの埋め込みベクトルの類似度**を表します。

- **範囲**: 0.0 ～ 1.0
- **1.0に近いほど**: 質問とドキュメントが非常に似ている
- **0.0に近いほど**: 質問とドキュメントが全く異なる

## 現在の状況

テスト結果から：
- **最大Similarityスコア**: 0.2517（25.17%の類似度）
- **平均Similarityスコア**: 0.1840（18.40%の類似度）
- **0.7以上のドキュメント**: 0件
- **0.5以上のドキュメント**: 0件

## 何が低いのか？

### 1. **埋め込みベクトルの類似度が低い**

質問「Zettelkastenとは何ですか？」の埋め込みベクトルと、ドキュメントの埋め込みベクトルの**意味的な類似度**が低いということです。

### 2. **検索結果にZettelkastenのドキュメントが含まれていない**

テスト結果を見ると、検索結果の上位7件にZettelkastenに関するドキュメントが含まれていません。これは、Zettelkastenのドキュメントの埋め込みベクトルが、質問の埋め込みベクトルと類似していないことを意味します。

## なぜ低いのか？

### 原因1: チャンクサイズが小さい

現在の設定：
- **チャンクサイズ**: 1000文字
- **オーバーラップ**: 200文字

小さなチャンクに分割されているため、**文脈が失われている**可能性があります。

例：
- 元のドキュメント: 「Zettelkastenとは、ドイツ語でメモ箱を意味し...」（320行）
- チャンク1: 「Zettelkastenとは、ドイツ語でメモ箱...」（1000文字）
- チャンク2: 「...メモ箱を意味し、情報管理...」（1000文字）

質問「Zettelkastenとは何ですか？」に対して、各チャンクが部分的にしか関連していないため、Similarityスコアが低くなります。

### 原因2: 埋め込みモデルの性能

使用しているモデル: `text-embedding-3-small`（512次元）

これは軽量モデルで、より高精度なモデル（`text-embedding-3-large`）と比べると、意味的な類似度の検出精度が低い可能性があります。

### 原因3: 質問とドキュメントの表現の違い

- **質問**: 「Zettelkastenとは何ですか？」（短い、定義を求める）
- **ドキュメント**: 「Zettelkastenとは？レポートが書けない原因を解決する最強のアイデア整理術」（長い、説明文）

表現の違いにより、埋め込みベクトルが異なる方向を向いている可能性があります。

## 解決方法

### 方法1: チャンクサイズを大きくする（推奨）

`scripts/train-markdown-files.ts`と`pages/api/train/url.ts`のチャンクサイズを変更：

```typescript
// 変更前
chunkSize: 1000

// 変更後
chunkSize: 2000  // または 3000
```

**メリット**: より多くの文脈が保持される
**デメリット**: チャンク数が減る、トークン数が増える

### 方法2: 埋め込みモデルを変更

```typescript
// 変更前
model: 'text-embedding-3-small',
dimensions: 512

// 変更後
model: 'text-embedding-3-large',
dimensions: 3072  // または 1536
```

**メリット**: より高精度な類似度検出
**デメリット**: コストが増える、処理時間が長くなる

### 方法3: 検索結果数を増やす（既に実施済み）

`match_count`を10から20に増やしました。これにより、より多くのドキュメントが検索対象になります。

### 方法4: ハイブリッド検索の導入

ベクトル検索に加えて、キーワード検索も組み合わせる方法です。

## 推奨される対応

1. **まずは現在の設定でテスト**
   - 検索結果数を20に増やしたので、Zettelkastenのドキュメントが含まれる可能性が高くなりました
   - プロンプトも改善したので、低いSimilarityスコアでも回答できるようになりました

2. **まだ問題が続く場合**
   - チャンクサイズを2000に変更して再学習
   - または、埋め込みモデルを`text-embedding-3-large`に変更

3. **根本的な解決**
   - チャンクサイズを大きくする（2000-3000文字）
   - より高精度な埋め込みモデルを使用する

## 参考

- Similarityスコアの一般的な目安：
  - **0.7以上**: 非常に類似している
  - **0.5-0.7**: 類似している
  - **0.3-0.5**: 部分的に類似している
  - **0.3未満**: 類似度が低い

現在の最大値0.2517は、**部分的に類似している**レベルです。

